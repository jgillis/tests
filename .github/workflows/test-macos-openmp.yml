name: Test macOS OpenMP

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-openmp:
    strategy:
      matrix:
        os: [macos-14, macos-15-intel]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Display compiler info
      run: |
        echo "=== System gcc (actually clang) ==="
        gcc --version
        which gcc
        echo ""
        echo "=== Checking for OpenMP libraries ==="
        brew list | grep -i omp || echo "No OpenMP libs found"

    - name: Experiment 1 - Try naive gcc with -fopenmp
      continue-on-error: true
      run: |
        echo "Attempting: gcc -fopenmp hello_openmp.c -o hello_openmp"
        gcc -fopenmp hello_openmp.c -o hello_openmp && ./hello_openmp

    - name: Experiment 2 - Install libomp and use Xpreprocessor flags
      continue-on-error: true
      run: |
        echo "Installing libomp via Homebrew..."
        brew install libomp
        echo ""
        echo "Attempting: gcc -Xpreprocessor -fopenmp -lomp"
        gcc -Xpreprocessor -fopenmp -lomp hello_openmp.c -o hello_openmp_exp2
        ./hello_openmp_exp2

    - name: Experiment 2b - Use Homebrew suggested environment variables
      continue-on-error: true
      run: |
        echo "Setting environment variables as suggested by Homebrew..."
        export LDFLAGS="-L/opt/homebrew/opt/libomp/lib"
        export CPPFLAGS="-I/opt/homebrew/opt/libomp/include"
        echo "LDFLAGS=$LDFLAGS"
        echo "CPPFLAGS=$CPPFLAGS"
        echo ""
        echo "Attempting: gcc -Xpreprocessor -fopenmp with env vars"
        gcc $CPPFLAGS -Xpreprocessor -fopenmp $LDFLAGS -lomp hello_openmp.c -o hello_openmp_exp2b
        ./hello_openmp_exp2b

    - name: Experiment 3 - Use explicit Homebrew libomp paths
      continue-on-error: true
      run: |
        echo "Setting up paths for libomp..."
        LIBOMP_PREFIX=$(brew --prefix libomp)
        echo "libomp location: $LIBOMP_PREFIX"
        echo ""
        echo "Attempting: gcc with explicit -I and -L flags"
        gcc -Xpreprocessor -fopenmp -I${LIBOMP_PREFIX}/include -L${LIBOMP_PREFIX}/lib -lomp hello_openmp.c -o hello_openmp_exp3
        ./hello_openmp_exp3

    - name: Experiment 4 - Install and use Homebrew GCC
      continue-on-error: true
      run: |
        echo "Installing Homebrew gcc..."
        brew install gcc
        GCC_BIN=$(brew --prefix gcc)/bin/gcc-$(brew list --versions gcc | grep -oE '[0-9]+' | head -1)
        echo "Found GCC at: $GCC_BIN"
        $GCC_BIN --version
        echo ""
        echo "Attempting: Homebrew gcc with -fopenmp"
        $GCC_BIN -fopenmp hello_openmp.c -o hello_openmp_exp4
        ./hello_openmp_exp4

    - name: Summary
      run: |
        echo "=== Compilation Results ==="
        ls -lh hello_openmp* 2>/dev/null || echo "No binaries found"
